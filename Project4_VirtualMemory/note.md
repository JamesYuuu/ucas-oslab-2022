记录虚页和物理页框对应关系的数据结构就叫页表

SATP reg

[mode] [asid] [ppn]

mode : SV39

asid : different processes

ppn  : 页目录所在的物理页框号

set_satp(SATP_MODE_SV39, 0, PGDIR_PA >> NORMAL_PAGE_SHIFT);


一般而言，页表的设计都遵循一个页表刚好占一页这样的模式。一页按照 4KB 计算，RISC-V 一个页表项需要8 Byte, 因此，一个页表可以容纳 512 个页表项。512 相当于 2 的 9 次方，因此，VPN 都设计为 9 位。这样便可将 VPN 作为下标定位到节点中的页表项。

R = W = X = 0 的时候， 代表其指向下一级页表

当想从一个非叶节点向下走时，只需找到对应的页表项的物理页号字段，它指向了下一级节点的物理页帧，这样非叶节点中转的功能也就实现了。

软件需要完成的工作是设置好一个新的进程的三级页表项并设置 satp 寄存器。

假设我们有虚拟地址 {VPN2[38:30], VPN1[29:21], VPN0[20:12], offset[11:0]}：

• 操作系统记录装载「当前所用的三级页表的物理页」的页号到 satp 寄存器中；
• VPN2 作为偏移在第三级页表的物理页中找到第二级页表的物理页号；
• VPN1 作为偏移在第二级页表的物理页中找到第一级页表的物理页号；
• VPN0 作为偏移在第一级页表的物理页中找到要访问位置的物理页号；
• 物理页号对应的物理页基址（即物理页号左移 12 位）加上 offset 就是虚拟地址对应的物理地址。

va pa pgdir

va 9 9 9 12

1 << 39 - 1 = 0 (1)*39 0

va >> (12 + 9 + 9) vpn2


set_pfn()

44 + 12     // 44 + 10 set attribute 1